name: Generate SEC API Historical Python SDK

on:
  push:
    branches:
      - master # Adjust to your default branch (e.g., main) if different
    paths:
      - 'finfeedapi/sec-api/spec/sec-api-historical.yaml'
  pull_request:
    branches:
      - master # Adjust to your default branch (e.g., main) if different
    paths:
      - 'finfeedapi/sec-api/spec/sec-api-historical.yaml'

jobs:
  build-and-commit-sdk:
    runs-on: ubuntu-latest
    steps:
      # - name: Checkout repository
      #   uses: actions/checkout@v2
      #   with:
      #     # This token is needed to push changes back to the repository.
      #     # Create a PAT with 'repo' scope and add it as a secret 
      #     # in your repository settings (e.g., Settings > Secrets > Actions).
      #     # Replace 'PAT_TOKEN' with the name of your secret.
      #     token: ${{ secrets.PAT_TOKEN }} 

      # - name: Install OpenAPI Generator CLI
      #   run: sudo npm install -g @openapitools/openapi-generator-cli@latest

      # - name: Generate Python SDK
      #   run: |
      #     echo "Generating Python SDK for finfeedapi/sec-api/spec/sec-api-historical.yaml"
      #     # Create the output directory if it doesn't exist
      #     mkdir -p finfeedapi/sec-api/sdk
      #     openapi-generator-cli generate \
      #       -i finfeedapi/sec-api/spec/sec-api-historical.yaml \
      #       -g python \
      #       -o finfeedapi/sec-api/sdk/ \
      #       -v
      #     echo "SDK generation complete."
      - name: Checkout repository
        uses: actions/checkout@v4 # Updated to a newer version
        with:
          # This token is needed to push changes back to the repository.
          # Create a PAT with 'repo' (or 'contents: write') scope and add it as a secret
          # in your repository settings (e.g., Settings > Secrets > Actions).
          # Replace 'PAT_TOKEN' with the name of your secret.
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' # Eclipse Temurin is a popular OpenJDK distribution
          java-version: '17'      # Or '11'. OpenAPI Generator generally requires Java 11+

      - name: Install OpenAPI Generator CLI
        run: |
          npm install -g @openapitools/openapi-generator-cli # Removed sudo, it's generally not needed and safer
          # Optionally, pin to a specific version to avoid unexpected updates:
          # npm install -g @openapitools/openapi-generator-cli@7.5.0 # Example version
          echo "OpenAPI Generator CLI installed."
          # Ensure the correct JAR is downloaded and selected, especially after a fresh install
          # This helps prevent the "undefined.jar" error.
          # Replace '7.5.0' with the version you intend to use or the latest stable one.
          # You can list available versions with: openapi-generator-cli version-manager list
          openapi-generator-cli version-manager set 7.5.0 # Example: Set to a specific stable version

      - name: Prepare OpenAPI Spec for Generator
        run: |
          echo "Original spec file: finfeedapi/sec-api/spec/sec-api-historical.yaml"
          NEW_SPEC_FILE_PATH="finfeedapi/sec-api/spec/sec-api-historical.json"
          OLD_SPEC_FILE_NAME="sec-api-historical.yaml"
          NEW_SPEC_FILE_NAME="sec-api-historical.json"

          # Rename the spec file to .json to ensure correct parsing
          if [ -f "finfeedapi/sec-api/spec/${OLD_SPEC_FILE_NAME}" ]; then
            echo "Renaming finfeedapi/sec-api/spec/${OLD_SPEC_FILE_NAME} to ${NEW_SPEC_FILE_PATH}"
            mv "finfeedapi/sec-api/spec/${OLD_SPEC_FILE_NAME}" "${NEW_SPEC_FILE_PATH}"
          else
            echo "Warning: Expected spec file finfeedapi/sec-api/spec/${OLD_SPEC_FILE_NAME} not found. Assuming it might have been already renamed or path is incorrect."
            # If the .json file already exists, we assume it's the correct one
            if [ ! -f "${NEW_SPEC_FILE_PATH}" ]; then
              echo "Error: Neither ${OLD_SPEC_FILE_NAME} nor ${NEW_SPEC_FILE_NAME} found in spec directory. Cannot proceed."
              exit 1
            fi
          fi
          
          echo "Updating inputSpec in generator config files to point to ${NEW_SPEC_FILE_NAME}..."
          CONFIG_DIR="finfeedapi/sec-api/sdk-config"
          find "${CONFIG_DIR}" -type f -name '*.yaml' -print0 | while IFS= read -r -d $'\\0' configFile; do
            echo "Processing ${configFile}..."
            # Using a temporary file for sed to ensure compatibility, especially with -i
            sed "s|\\(inputSpec:.*\\)${OLD_SPEC_FILE_NAME}|\\1${NEW_SPEC_FILE_NAME}|g" "${configFile}" > "${configFile}.tmp" && mv "${configFile}.tmp" "${configFile}"
            echo "Updated inputSpec in ${configFile} if necessary."
          done
          echo "Finished preparing OpenAPI spec and config files."

      - name: Generate SDKs
        run: |
          set -e # Exit immediately if a command exits with a non-zero status.

          echo "Generating SDKs using configurations in finfeedapi/sec-api/sdk-config/"
          # Define base output directory for all SDKs
          SDK_OUTPUT_DIR="finfeedapi/sec-api/sdk"

          # Create the base output directory if it doesn't exist
          mkdir -p "${SDK_OUTPUT_DIR}"

          # Clean the base SDK directory before generation.
          # This ensures no stale files are left. The batch process, guided by
          # the config files, should then create language-specific subdirectories
          # (e.g., ${SDK_OUTPUT_DIR}/python, ${SDK_OUTPUT_DIR}/java)
          # within this cleaned directory.
          echo "Cleaning previous SDKs (if any) from ${SDK_OUTPUT_DIR}..."
          rm -rf "${SDK_OUTPUT_DIR:?}"/* # The :? ensures the variable is set, preventing accidental deletion of root if empty

          # IMPORTANT: Ensure your *.yaml config files in finfeedapi/sec-api/sdk-config/
          # have their 'outputDir' property correctly set to create language-specific
          # subdirectories under "${SDK_OUTPUT_DIR}".
          # For example, a config file 'sdk-config/python.yaml' should specify an
          # outputDir like '../sdk/python' (relative to the config file) or
          # an absolute path like '${{ github.workspace }}/finfeedapi/sec-api/sdk/python'.
          echo "Running OpenAPI Generator CLI batch process..."
          openapi-generator-cli batch finfeedapi/sec-api/sdk-config/*.yaml -v

          echo "SDKs generation complete."

      - name: Commit and Push SDK
        # Only run this step for push events to the specified branch
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') # Adjust branch names as needed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@users.noreply.github.com'
          
          # Navigate to repository root
          cd "${{ github.workspace }}"

          echo "Adding files from finfeedapi/sec-api/sdk/"
          # Add all changes within the SDK directory (new, modified, deleted)
          git add finfeedapi/sec-api/sdk/

          # Check if there are actual changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit in SDK."
          else
            echo "Changes detected, committing..."
            git commit -m "Auto-generate Python SDK for SEC API Historical [skip ci]"
            
            # Configure pull strategy (merge by default if not rebase)
            # The example you provided used 'git config pull.rebase false' implicitly by not setting rebase.
            # This ensures a merge commit if the remote has diverged.
            git config pull.rebase false 
            
            CURRENT_BRANCH=$(echo "${{ github.ref }}" | sed 's!refs/heads/!!')
            echo "Pulling latest changes from origin/${CURRENT_BRANCH}..."
            git pull origin ${CURRENT_BRANCH}
            
            echo "Pushing changes to origin/${CURRENT_BRANCH}..."
            git push origin ${CURRENT_BRANCH}
            echo "Push complete."
          fi 
